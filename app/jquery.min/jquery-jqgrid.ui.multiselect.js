(function(b){b.widget("ui.multiselect",{_init:function(){this.element.hide();this.id=this.element.attr("id");this.container=b('<div class="ui-multiselect ui-helper-clearfix ui-widget"></div>').insertAfter(this.element);this.count=0;this.selectedContainer=b('<div class="selected"></div>').appendTo(this.container);this.availableContainer=b('<div class="available"></div>').appendTo(this.container);this.selectedActions=b('<div class="actions ui-widget-header ui-helper-clearfix"><span class="count">0 '+
b.ui.multiselect.locale.itemsCount+'</span><a href="#" class="remove-all">'+b.ui.multiselect.locale.removeAll+"</a></div>").appendTo(this.selectedContainer);this.availableActions=b('<div class="actions ui-widget-header ui-helper-clearfix"><input type="text" class="search empty ui-widget-content ui-corner-all"/><a href="#" class="add-all">'+b.ui.multiselect.locale.addAll+"</a></div>").appendTo(this.availableContainer);this.selectedList=b('<ul class="selected connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",
function(){return false}).appendTo(this.selectedContainer);this.availableList=b('<ul class="available connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return false}).appendTo(this.availableContainer);var a=this;this.container.width(this.element.width()+1);this.selectedContainer.width(Math.floor(this.element.width()*this.options.dividerLocation));this.availableContainer.width(Math.floor(this.element.width()*(1-this.options.dividerLocation)));this.selectedList.height(Math.max(this.element.height()-
this.selectedActions.height(),1));this.availableList.height(Math.max(this.element.height()-this.availableActions.height(),1));if(!this.options.animated){this.options.show="show";this.options.hide="hide"}this._populateLists(this.element.find("option"));this.options.sortable&&b("ul.selected").sortable({placeholder:"ui-state-highlight",axis:"y",update:function(){a.selectedList.find("li").each(function(){b(this).data("optionLink")&&b(this).data("optionLink").remove().appendTo(a.element)})},receive:function(c,
d){d.item.data("optionLink").attr("selected",true);a.count+=1;a._updateCount();a.selectedList.children(".ui-draggable").each(function(){b(this).removeClass("ui-draggable");b(this).data("optionLink",d.item.data("optionLink"));b(this).data("idx",d.item.data("idx"));a._applyItemState(b(this),true)});setTimeout(function(){d.item.remove()},1)}});this.options.searchable?this._registerSearchEvents(this.availableContainer.find("input.search")):b(".search").hide();b(".remove-all").click(function(){a._populateLists(a.element.find("option").removeAttr("selected"));
return false});b(".add-all").click(function(){a._populateLists(a.element.find("option").attr("selected","selected"));return false})},destroy:function(){this.element.show();this.container.remove();b.widget.prototype.destroy.apply(this,arguments)},_populateLists:function(a){this.selectedList.children(".ui-element").remove();this.availableList.children(".ui-element").remove();this.count=0;var c=this;b(a.map(function(d){var f=c._getOptionNode(this).appendTo(this.selected?c.selectedList:c.availableList).show();
if(this.selected)c.count+=1;c._applyItemState(f,this.selected);f.data("idx",d);return f[0]}));this._updateCount()},_updateCount:function(){this.selectedContainer.find("span.count").text(this.count+" "+b.ui.multiselect.locale.itemsCount)},_getOptionNode:function(a){a=b(a);var c=b('<li class="ui-state-default ui-element" title="'+a.text()+'"><span class="ui-icon"/>'+a.text()+'<a href="#" class="action"><span class="ui-corner-all ui-icon"/></a></li>').hide();c.data("optionLink",a);return c},_cloneWithData:function(a){var c=
a.clone();c.data("optionLink",a.data("optionLink"));c.data("idx",a.data("idx"));return c},_setSelected:function(a,c){a.data("optionLink").attr("selected",c);if(c){c=this._cloneWithData(a);a[this.options.hide](this.options.animated,function(){b(this).remove()});c.appendTo(this.selectedList).hide()[this.options.show](this.options.animated);this._applyItemState(c,true);return c}else{var d=this.availableList.find("li"),f=this.options.nodeComparator;c=null;var e=a.data("idx"),g=f(a,b(d[e]));if(g)for(;e>=
0&&e<d.length;){g>0?e++:e--;if(g!=f(a,b(d[e]))){c=d[g>0?e:e+1];break}}else c=d[e];d=this._cloneWithData(a);c?d.insertBefore(b(c)):d.appendTo(this.availableList);a[this.options.hide](this.options.animated,function(){b(this).remove()});d.hide()[this.options.show](this.options.animated);this._applyItemState(d,false);return d}},_applyItemState:function(a,c){if(c){this.options.sortable?a.children("span").addClass("ui-icon-arrowthick-2-n-s").removeClass("ui-helper-hidden").addClass("ui-icon"):a.children("span").removeClass("ui-icon-arrowthick-2-n-s").addClass("ui-helper-hidden").removeClass("ui-icon");
a.find("a.action span").addClass("ui-icon-minus").removeClass("ui-icon-plus");this._registerRemoveEvents(a.find("a.action"))}else{a.children("span").removeClass("ui-icon-arrowthick-2-n-s").addClass("ui-helper-hidden").removeClass("ui-icon");a.find("a.action span").addClass("ui-icon-plus").removeClass("ui-icon-minus");this._registerAddEvents(a.find("a.action"))}this._registerHoverEvents(a)},_filter:function(a){var c=b(this),d=a.children("li");a=d.map(function(){return b(this).text().toLowerCase()});
var f=b.trim(c.val().toLowerCase()),e=[];if(f){d.hide();a.each(function(g){this.indexOf(f)>-1&&e.push(g)});b.each(e,function(){b(d[this]).show()})}else d.show()},_registerHoverEvents:function(a){a.removeClass("ui-state-hover");a.mouseover(function(){b(this).addClass("ui-state-hover")});a.mouseout(function(){b(this).removeClass("ui-state-hover")})},_registerAddEvents:function(a){var c=this;a.click(function(){c._setSelected(b(this).parent(),true);c.count+=1;c._updateCount();return false}).each(function(){b(this).parent().draggable({connectToSortable:"ul.selected",
helper:function(){var d=c._cloneWithData(b(this)).width(b(this).width()-50);d.width(b(this).width());return d},appendTo:".ui-multiselect",containment:".ui-multiselect",revert:"invalid"})})},_registerRemoveEvents:function(a){var c=this;a.click(function(){c._setSelected(b(this).parent(),false);c.count-=1;c._updateCount();return false})},_registerSearchEvents:function(a){var c=this;a.focus(function(){b(this).addClass("ui-state-active")}).blur(function(){b(this).removeClass("ui-state-active")}).keypress(function(d){if(d.keyCode==
13)return false}).keyup(function(){c._filter.apply(this,[c.availableList])})}});b.extend(b.ui.multiselect,{defaults:{sortable:true,searchable:true,animated:"fast",show:"slideDown",hide:"slideUp",dividerLocation:0.6,nodeComparator:function(a,c){a=a.text();c=c.text();return a==c?0:a<c?-1:1}},locale:{addAll:"Add all",removeAll:"Remove all",itemsCount:"items selected"}})})(jQuery);
